<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construction Map Viewer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-top: 20px;
        }
        .map-container {
            position: relative;
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .map-container img, .map-container iframe {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .event-marker {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: red;
            border-radius: 50%;
            border: 2px solid white;
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 100;
        }
        .login-form {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .event-form {
            display: none;
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        .table-responsive {
            margin-top: 20px;
        }
        .map-layers-control {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            min-width: 200px;
        }
        .map-iframe-container {
            position: relative;
            width: 100%;
            height: 100%;
        }
        .map-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
        }
        .event-popup {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            z-index: 1001;
            max-width: 300px;
        }
        .user-color-1 { background-color: #FF5733; }
        .user-color-2 { background-color: #33FF57; }
        .user-color-3 { background-color: #3357FF; }
        .user-color-4 { background-color: #F033FF; }
        .user-color-5 { background-color: #FF9933; }
        
        /* Improved PDF Object Styling */
        .pdf-object {
            display: block;
            width: 100%;
            height: 100%;
            border: none;
            background-color: white;
        }
        
        /* Fix for Firefox PDF rendering */
        @-moz-document url-prefix() {
            .pdf-object {
                height: 99%;
                width: 99%;
            }
        }
        
        /* Clean PDF view styling - remove all UI elements */
        .clean-pdf-view {
            background-color: white;
            border: none;
            overflow: hidden;
        }
        
        /* Enhanced map layers control */
        .map-layers-control {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            min-width: 200px;
        }
        
        .map-layer-checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 3px;
            transition: background-color 0.2s;
        }
        
        .map-layer-checkbox-container:hover {
            background-color: #f8f9fa;
        }
        
        .base-map-label {
            font-weight: bold;
            color: #0d6efd;
        }
        
        .overlay-map-label {
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Section -->
        <div id="loginSection" class="login-form">
            <h2 class="text-center mb-4">Login</h2>
            <div class="mb-3">
                <label for="username" class="form-label">Username</label>
                <input type="text" class="form-control" id="username" value="admin">
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <input type="password" class="form-control" id="password" value="admin">
            </div>
            <button id="loginBtn" class="btn btn-primary w-100">Login</button>
            <div id="loginError" class="alert alert-danger mt-3" style="display: none;"></div>
        </div>

        <!-- Main App Section (hidden until login) -->
        <div id="appSection" style="display: none;">
            <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
                <div class="container-fluid">
                    <a class="navbar-brand" href="#">Construction Map</a>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarNav">
                        <ul class="navbar-nav">
                            <li class="nav-item">
                                <a class="nav-link active" href="#" id="projectsLink">Projects</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" id="eventsLink">Events</a>
                            </li>
                        </ul>
                        <ul class="navbar-nav ms-auto">
                            <li class="nav-item">
                                <a class="nav-link" href="#" id="logoutBtn">Logout</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>

            <!-- Projects Section -->
            <div id="projectsSection">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Projects</h2>
                    <button id="createProjectBtn" class="btn btn-primary">Create Project</button>
                </div>
                <div id="projectsList" class="row"></div>
            </div>

            <!-- Project Detail Section -->
            <div id="projectDetailSection" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <button id="backToProjectsBtn" class="btn btn-outline-secondary">← Back to Projects</button>
                    <button id="deleteProjectBtn" class="btn btn-danger">Delete Project</button>
                </div>
                <h2 id="projectTitle" class="mb-4"></h2>
                
                <ul class="nav nav-tabs mb-4" id="projectTabs">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#mainMapTab">Main View</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#mapsTab">Maps</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#detailsTab">Details</a>
                    </li>
                </ul>
                
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="mainMapTab">
                        <div class="d-flex justify-content-between mb-3">
                            <h4>Project Map View</h4>
                            <button id="addEventBtn" class="btn btn-success">Add Event</button>
                        </div>
                        <div id="mainMapContainer" class="map-container">
                            <div id="mapLayersControl" class="map-layers-control">
                                <h6>Map Layers</h6>
                                <div id="mapLayersList">
                                    <!-- Map layers will be populated here -->
                                </div>
                            </div>
                            <div id="mainMapViewer">
                                <!-- Main map and overlays will be displayed here -->
                            </div>
                            <div id="eventMarkersContainer">
                                <!-- Event markers will be added here -->
                            </div>
                            <div id="eventPopup" class="event-popup" style="display: none;">
                                <!-- Event popup details will be displayed here -->
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <h5>Recent Events</h5>
                            <div id="recentEventsTable" class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Title</th>
                                            <th>Description</th>
                                            <th>Status</th>
                                            <th>Created By</th>
                                            <th>Created</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentEventsTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-pane fade" id="mapsTab">
                        <div class="d-flex justify-content-between mb-3">
                            <h4>Project Maps</h4>
                            <button id="uploadMapBtn" class="btn btn-success">Upload Map</button>
                        </div>
                        <div id="mapsList" class="row"></div>
                    </div>
                    
                    <div class="tab-pane fade" id="detailsTab">
                        <div class="card">
                            <div class="card-body">
                                <h5>Description</h5>
                                <p id="projectDescription"></p>
                                <h5 class="mt-4">Project Information</h5>
                                <p id="projectCreated"></p>
                                <p id="projectUpdated"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Map Detail Section -->
            <div id="mapDetailSection" style="display: none;">
                <button id="backToProjectBtn" class="btn btn-outline-secondary mb-3">← Back to Project</button>
                <h2 id="mapTitle" class="mb-4"></h2>
                
                <ul class="nav nav-tabs mb-4" id="mapTabs">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#mapViewTab">Map View</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#eventsListTab">Events List</a>
                    </li>
                </ul>
                
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="mapViewTab">
                        <p class="mb-3">Click anywhere on the map to report an incident or issue at that location.</p>
                        <div id="mapContainer" class="map-container">
                            <!-- Map will be loaded here -->
                        </div>
                    </div>
                    <div class="tab-pane fade" id="eventsListTab">
                        <h4>Map Events</h4>
                        <div id="eventsTable" class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Description</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="eventsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Events Section -->
            <div id="eventsSection" style="display: none;">
                <h2 class="mb-4">All Events</h2>
                
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Filters</h5>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="projectFilter" class="form-label">Project</label>
                                    <select id="projectFilter" class="form-select">
                                        <option value="">All Projects</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="mapFilter" class="form-label">Map</label>
                                    <select id="mapFilter" class="form-select">
                                        <option value="">All Maps</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="statusFilter" class="form-label">Status</label>
                                    <select id="statusFilter" class="form-select">
                                        <option value="">All Statuses</option>
                                        <option value="open">Open</option>
                                        <option value="in_progress">In Progress</option>
                                        <option value="resolved">Resolved</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="allEventsTable" class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Project</th>
                                <th>Map</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="allEventsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Create Project Modal -->
        <div class="modal fade" id="createProjectModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Create New Project</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="projectName" class="form-label">Project Name</label>
                            <input type="text" class="form-control" id="projectName" required>
                        </div>
                        <div class="mb-3">
                            <label for="projectDesc" class="form-label">Description</label>
                            <textarea class="form-control" id="projectDesc" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" id="saveProjectBtn" class="btn btn-primary">Create Project</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload Map Modal -->
        <div class="modal fade" id="uploadMapModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Upload New Map</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="mapUploadError" class="alert alert-danger" style="display: none;"></div>
                        <div class="mb-3">
                            <label for="mapName" class="form-label">Map Name</label>
                            <input type="text" class="form-control" id="mapName" required>
                        </div>
                        <div class="mb-3">
                            <label for="mapFile" class="form-label">Map File</label>
                            <input type="file" class="form-control" id="mapFile" accept="application/pdf" required>
                            <div class="form-text">Upload a PDF file of your construction map.</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" id="saveMapBtn" class="btn btn-primary">Upload Map</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Event Modal -->
        <div class="modal fade" id="createEventModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Report New Incident</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="eventError" class="alert alert-danger" style="display: none;"></div>
                        <div class="mb-3">
                            <label for="eventTitle" class="form-label">Title</label>
                            <input type="text" class="form-control" id="eventTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="eventDesc" class="form-label">Description</label>
                            <textarea class="form-control" id="eventDesc" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="eventStatus" class="form-label">Status</label>
                            <select class="form-select" id="eventStatus">
                                <option value="open">Open</option>
                                <option value="in_progress">In Progress</option>
                                <option value="resolved">Resolved</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="eventImage" class="form-label">Image</label>
                            <div class="d-flex">
                                <button type="button" id="takePictureBtn" class="btn btn-outline-primary me-2">Take Picture</button>
                                <input type="file" class="form-control" id="eventImage" accept="image/*" capture="environment">
                            </div>
                            <div class="form-text">Take a photo or upload an image of the incident</div>
                        </div>
                        <div id="capturedImagePreview" class="mt-2 text-center" style="display: none;">
                            <img id="previewImage" src="" alt="Preview" style="max-width: 100%; max-height: 200px;">
                        </div>
                        <p class="text-muted mt-3" id="eventCoordinates"></p>
                        <p class="text-muted" id="activeMapLayers"></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" id="saveEventBtn" class="btn btn-primary">Create Incident</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Event Details Modal -->
        <div class="modal fade" id="eventDetailsModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="eventDetailsTitle">Event Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <h6>Description</h6>
                            <p id="eventDetailsDesc"></p>
                        </div>
                        <div class="mb-3">
                            <h6>Status</h6>
                            <p id="eventDetailsStatus"></p>
                        </div>
                        <div class="mb-3">
                            <h6>Created By</h6>
                            <p id="eventDetailsCreator"></p>
                        </div>
                        <div class="mb-3">
                            <h6>Created On</h6>
                            <p id="eventDetailsDate"></p>
                        </div>
                        <div class="mb-3" id="eventDetailsImageContainer" style="display: none;">
                            <h6>Image</h6>
                            <img id="eventDetailsImage" src="" alt="Event Image" style="max-width: 100%;">
                        </div>
                        <div class="mb-3">
                            <h6>Map Layers Active</h6>
                            <p id="eventDetailsMapLayers"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // API base URL
        const API_URL = 'http://127.0.0.1:8000/api/v1';
        
        // State variables
        let token = localStorage.getItem('token');
        let currentUser = null;
        let currentProject = null;
        let currentMap = null;
        let projects = [];
        let maps = [];
        let events = [];
        let selectedPosition = { x: 0, y: 0 };
        let activeMaps = {};  // Tracks which maps are active in the overlay
        let userColors = {};  // Maps user IDs to colors
        const colorClasses = ['user-color-1', 'user-color-2', 'user-color-3', 'user-color-4', 'user-color-5'];
        
        // Get user color by ID (assign if not already assigned)
        function getUserColorClass(userId) {
            if (!userColors[userId]) {
                // Assign next color in rotation
                const colorIndex = Object.keys(userColors).length % colorClasses.length;
                userColors[userId] = colorClasses[colorIndex];
            }
            return userColors[userId];
        }
        
        // Elements
        const loginSection = document.getElementById('loginSection');
        const appSection = document.getElementById('appSection');
        const projectsSection = document.getElementById('projectsSection');
        const projectDetailSection = document.getElementById('projectDetailSection');
        const mapDetailSection = document.getElementById('mapDetailSection');
        const eventsSection = document.getElementById('eventsSection');
        
        // Bootstrap modals
        const createProjectModal = new bootstrap.Modal(document.getElementById('createProjectModal'));
        const uploadMapModal = new bootstrap.Modal(document.getElementById('uploadMapModal'));
        const createEventModal = new bootstrap.Modal(document.getElementById('createEventModal'));
        const eventDetailsModal = new bootstrap.Modal(document.getElementById('eventDetailsModal'));

        // Check if user is logged in
        function checkAuth() {
            if (token) {
                loginSection.style.display = 'none';
                appSection.style.display = 'block';
                fetchProjects();
            } else {
                loginSection.style.display = 'block';
                appSection.style.display = 'none';
            }
        }

        // API request helper
        async function apiRequest(endpoint, method = 'GET', data = null) {
            console.log(`API Request: ${method} ${API_URL}${endpoint}`);
            const headers = {
                'Accept': 'application/json',
            };
            
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            
            const options = {
                method,
                headers
            };
            
            if (data) {
                if (data instanceof FormData) {
                    // For FormData, don't set Content-Type (browser will set it with boundary)
                    options.body = data;
                    console.log('Sending FormData:', Object.fromEntries(data.entries()));
                } else {
                    headers['Content-Type'] = 'application/json';
                    options.body = JSON.stringify(data);
                    console.log('Sending JSON data:', data);
                }
            }
            
            console.log('Request options:', { method, endpoint, headers });
            
            try {
                const response = await fetch(`${API_URL}${endpoint}`, options);
                console.log(`Response status: ${response.status}`);
                
                if (response.status === 401) {
                    // Unauthorized, clear token and redirect to login
                    localStorage.removeItem('token');
                    token = null;
                    checkAuth();
                    throw new Error('Unauthorized');
                }
                
                if (!response.ok) {
                    let errorDetail = 'API request failed';
                    try {
                        const errorText = await response.text();
                        console.error('API error response:', errorText);
                        
                        if (errorText) {
                            try {
                                const errorObj = JSON.parse(errorText);
                                errorDetail = errorObj.detail || errorText;
                            } catch (e) {
                                errorDetail = errorText;
                            }
                        }
                    } catch (e) {
                        console.error('Error parsing error response:', e);
                    }
                    throw new Error(errorDetail);
                }
                
                // Special handling for 204 No Content responses
                if (response.status === 204) {
                    console.log('No content returned (status 204)');
                    return { success: true };
                }
                
                // For other successful responses, try to parse JSON
                try {
                    const responseData = await response.json();
                    return responseData;
                } catch (error) {
                    console.warn('Response is not valid JSON, returning raw response');
                    return { success: true, message: 'Operation successful' };
                }
            } catch (error) {
                console.error(`API request failed: ${endpoint}`, error);
                throw error;
            }
        }

        // Login
        document.getElementById('loginBtn').addEventListener('click', async () => {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginError = document.getElementById('loginError');
            
            if (!username || !password) {
                loginError.textContent = 'Please enter both username and password';
                loginError.style.display = 'block';
                return;
            }
            
            try {
                loginError.style.display = 'none';
                
                const formData = new FormData();
                formData.append('username', username);
                formData.append('password', password);
                
                const response = await apiRequest('/auth/login', 'POST', formData);
                
                if (response.access_token) {
                    token = response.access_token;
                    localStorage.setItem('token', token);
                    
                    // Get current user info
                    try {
                        currentUser = await apiRequest('/users/me');
                        console.log('Current user:', currentUser);
                    } catch (error) {
                        console.error('Error fetching user info:', error);
                    }
                    
                    checkAuth();
                } else {
                    loginError.textContent = 'Login failed';
                    loginError.style.display = 'block';
                }
            } catch (error) {
                console.error('Login error:', error);
                loginError.textContent = 'Invalid username or password';
                loginError.style.display = 'block';
            }
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('token');
            token = null;
            checkAuth();
        });

        // Navigation
        document.getElementById('projectsLink').addEventListener('click', () => {
            showSection('projects');
        });
        
        document.getElementById('eventsLink').addEventListener('click', () => {
            showSection('events');
            fetchAllEvents();
        });
        
        document.getElementById('backToProjectsBtn').addEventListener('click', () => {
            showSection('projects');
        });
        
        document.getElementById('backToProjectBtn').addEventListener('click', () => {
            showSection('projectDetail');
        });

        // Show appropriate section
        function showSection(section) {
            projectsSection.style.display = 'none';
            projectDetailSection.style.display = 'none';
            mapDetailSection.style.display = 'none';
            eventsSection.style.display = 'none';
            
            switch (section) {
                case 'projects':
                    projectsSection.style.display = 'block';
                    break;
                case 'projectDetail':
                    projectDetailSection.style.display = 'block';
                    break;
                case 'mapDetail':
                    mapDetailSection.style.display = 'block';
                    break;
                case 'events':
                    eventsSection.style.display = 'block';
                    break;
            }
        }

        // Fetch projects
        async function fetchProjects() {
            try {
                console.log('Fetching projects...');
                const response = await apiRequest('/projects/');
                console.log('Projects response:', response);
                projects = response; // The API returns an array directly
                renderProjects();
                
                // Also populate project filter for events section
                const projectFilter = document.getElementById('projectFilter');
                projectFilter.innerHTML = '<option value="">All Projects</option>';
                
                projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.name;
                    projectFilter.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching projects:', error);
            }
        }

        // Render projects list
        function renderProjects() {
            const projectsList = document.getElementById('projectsList');
            projectsList.innerHTML = '';
            
            if (projects.length === 0) {
                projectsList.innerHTML = '<div class="col-12"><div class="alert alert-info">No projects found. Click "Create Project" to get started.</div></div>';
                return;
            }
            
            console.log('Rendering projects:', projects);
            
            projects.forEach(project => {
                const projectCard = document.createElement('div');
                projectCard.className = 'col-md-4 mb-4';
                projectCard.innerHTML = `
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">${project.name}</h5>
                            <p class="card-text">${project.description || 'No description provided'}</p>
                        </div>
                        <div class="card-footer bg-transparent">
                            <button class="btn btn-primary btn-sm view-project" data-id="${project.id}">View Project</button>
                        </div>
                    </div>
                `;
                
                projectsList.appendChild(projectCard);
            });
            
            // Add event listeners to view project buttons
            document.querySelectorAll('.view-project').forEach(button => {
                button.addEventListener('click', (e) => {
                    const projectId = e.target.getAttribute('data-id');
                    viewProject(projectId);
                });
            });
        }

        // View a project
        async function viewProject(projectId) {
            try {
                console.log('Viewing project:', projectId);
                const response = await apiRequest(`/projects/${projectId}`);
                console.log('Project details:', response);
                currentProject = response;
                
                // Update project detail view
                document.getElementById('projectTitle').textContent = currentProject.name;
                document.getElementById('projectDescription').textContent = currentProject.description || 'No description provided';
                document.getElementById('projectCreated').textContent = `Created: ${new Date(currentProject.created_at).toLocaleString()}`;
                document.getElementById('projectUpdated').textContent = `Last Updated: ${new Date(currentProject.updated_at).toLocaleString()}`;
                
                // Fetch maps for this project
                await fetchProjectMaps(projectId);
                
                // Initialize main map view
                initializeMainMapView();
                
                // Show project detail section
                showSection('projectDetail');
            } catch (error) {
                console.error('Error viewing project:', error);
            }
        }

        // Fetch maps for a project
        async function fetchProjectMaps(projectId) {
            try {
                console.log('Fetching maps for project:', projectId);
                const response = await apiRequest(`/maps/?project_id=${projectId}`);
                maps = response;
                console.log('Maps retrieved:', maps);
                renderProjectMaps();
            } catch (error) {
                console.error('Error fetching maps:', error);
            }
        }

        // Render maps for current project
        function renderProjectMaps() {
            const mapsList = document.getElementById('mapsList');
            mapsList.innerHTML = '';
            
            if (maps.length === 0) {
                mapsList.innerHTML = '<div class="col-12"><div class="alert alert-info">No maps found for this project. Click "Upload Map" to add a map.</div></div>';
                return;
            }
            
            console.log('Rendering maps:', maps);
            
            maps.forEach(map => {
                const mapCard = document.createElement('div');
                mapCard.className = 'col-md-4 mb-4';
                
                // Format the date properly, fallback to "Unknown" if not available
                const uploadDate = map.created_at || map.uploaded_at 
                    ? new Date(map.created_at || map.uploaded_at).toLocaleDateString() 
                    : 'Unknown';
                            
                mapCard.innerHTML = `
                    <div class="card h-100">
                        <div class="card-img-top text-center bg-light" style="height: 200px;">
                            <div class="p-3 d-flex align-items-center justify-content-center h-100">
                                <i class="bi bi-file-pdf" style="font-size: 5rem;"></i>
                                <span class="badge bg-secondary position-absolute top-0 end-0 m-2">PDF</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">${map.name}</h5>
                            <p class="card-text">
                                <span class="badge bg-info">${map.map_type || 'Map'}</span>
                                ${map.version ? `<span class="badge bg-secondary">v${map.version}</span>` : ''}
                                <small class="text-muted d-block mt-2">Uploaded: ${uploadDate}</small>
                            </p>
                        </div>
                        <div class="card-footer bg-transparent">
                            <button class="btn btn-primary btn-sm view-map" data-id="${map.id}">View Map</button>
                        </div>
                    </div>
                `;
                
                mapsList.appendChild(mapCard);
            });
            
            // Add event listeners to view map buttons
            document.querySelectorAll('.view-map').forEach(button => {
                button.addEventListener('click', (e) => {
                    const mapId = e.target.getAttribute('data-id');
                    viewMap(mapId);
                });
            });
        }

        // View map details
        async function viewMap(mapId) {
            try {
                console.log('Viewing map with ID:', mapId);
                const response = await apiRequest(`/maps/${mapId}`);
                console.log('Map details response:', response);
                
                // Handle potential response formats
                currentMap = response.data || response;
                
                if (!currentMap) {
                    console.error('Invalid map data received:', response);
                    alert('Error: Could not load map data');
                    return;
                }
                
                console.log('Current map set to:', currentMap);
                
                // Set map details
                document.getElementById('mapTitle').textContent = currentMap.name;
                
                // Get base URL (without /api/v1)
                const apiUrlBase = API_URL.split('/api/v1')[0];
                
                // Construct proper URL for the map
                let mapUrl;
                if (currentMap.filename) {
                    mapUrl = `${apiUrlBase}/uploads/${currentMap.filename}`;
                } else if (currentMap.file_path) {
                    if (currentMap.file_path.includes('uploads/')) {
                        mapUrl = `${apiUrlBase}/${currentMap.file_path}`;
                    } else {
                        mapUrl = `${apiUrlBase}/uploads/${currentMap.file_path}`;
                    }
                } else {
                    console.error('Map has no filename or file_path:', currentMap);
                    alert('Error: Map file information is missing');
                    return;
                }
                
                console.log('Loading map from URL:', mapUrl);
                
                // Load map with PDF object for better PDF display
                const mapContainer = document.getElementById('mapContainer');
                mapContainer.innerHTML = `
                    <object data="${mapUrl}" type="application/pdf" width="100%" height="600px" class="map-viewer">
                        <div class="alert alert-warning">
                            Unable to display PDF. <a href="${mapUrl}" target="_blank">Download Instead</a>
                        </div>
                    </object>
                `;
                
                // Fetch events for this map
                fetchMapEvents(mapId);
                
                // Show map detail section
                showSection('mapDetail');
            } catch (error) {
                console.error('Error viewing map:', error);
                alert('Failed to load map details: ' + error.message);
            }
        }

        // Handle map click for adding events
        function handleMapClick(e) {
            const rect = e.target.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Calculate percentage position (useful for different screen sizes)
            const xPercent = (x / rect.width) * 100;
            const yPercent = (y / rect.height) * 100;
            
            selectedPosition = { x: xPercent, y: yPercent };
            
            // Show coordinates in the event form
            document.getElementById('eventCoordinates').textContent = `Incident coordinates: X: ${xPercent.toFixed(2)}%, Y: ${yPercent.toFixed(2)}%`;
            
            // Show event creation modal
            createEventModal.show();
        }

        // Fetch events for a map
        async function fetchMapEvents(mapId) {
            try {
                const response = await apiRequest('/events/');
                // Filter events by map
                events = response.data.filter(event => event.map_id === parseInt(mapId));
                
                // Render events on map
                renderMapEvents();
                
                // Render events table
                renderEventsTable();
            } catch (error) {
                console.error('Error fetching events:', error);
            }
        }

        // Render event markers on the map
        function renderMapEvents() {
            const mapImage = document.getElementById('mapImage');
            
            // Clear existing markers
            document.querySelectorAll('.event-marker').forEach(marker => marker.remove());
            
            // Add new markers
            events.forEach(event => {
                const marker = document.createElement('div');
                marker.className = 'event-marker';
                marker.title = event.title;
                marker.style.left = `${event.x_coordinate}%`;
                marker.style.top = `${event.y_coordinate}%`;
                
                // Add click event for marker
                marker.addEventListener('click', () => {
                    alert(`Event: ${event.title}\nDescription: ${event.description}\nStatus: ${event.status}`);
                });
                
                mapImage.parentNode.appendChild(marker);
            });
        }

        // Render events table
        function renderEventsTable() {
            const eventsTableBody = document.getElementById('eventsTableBody');
            eventsTableBody.innerHTML = '';
            
            if (events.length === 0) {
                document.getElementById('eventsTable').innerHTML = '<div class="alert alert-info">No events found for this map. Click on the map to create a new event.</div>';
                return;
            }
            
            events.forEach(event => {
                const row = document.createElement('tr');
                
                const statusClass = event.status === 'open' ? 'danger' : 
                                   event.status === 'in_progress' ? 'warning' : 'success';
                
                row.innerHTML = `
                    <td>${event.title}</td>
                    <td>${event.description}</td>
                    <td><span class="badge bg-${statusClass}">${event.status.replace('_', ' ')}</span></td>
                    <td>${new Date(event.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-outline-primary btn-sm view-event" data-id="${event.id}">View</button>
                    </td>
                `;
                
                eventsTableBody.appendChild(row);
            });
        }

        // Fetch all events (for events page)
        async function fetchAllEvents() {
            try {
                console.log('Fetching all events...');
                // Fetch projects for the user
                const projectsResponse = await apiRequest('/projects/');
                console.log('Projects for events:', projectsResponse);
                const projects = projectsResponse;
                
                // Initialize arrays for maps and events
                const allMaps = [];
                const events = [];
                
                // If there are no projects, just render empty tables
                if (projects.length === 0) {
                    renderAllEventsTable(events, allMaps);
                    return;
                }
                
                // Get maps for each project
                for (const project of projects) {
                    try {
                        const mapsResponse = await apiRequest(`/maps/?project_id=${project.id}`);
                        console.log(`Maps for project ${project.id}:`, mapsResponse);
                        if (Array.isArray(mapsResponse)) {
                            allMaps.push(...mapsResponse);
                        }
                    } catch (err) {
                        console.error(`Error fetching maps for project ${project.id}:`, err);
                    }
                }
                
                // Get events for each project
                for (const project of projects) {
                    try {
                        const eventsResponse = await apiRequest(`/events/?project_id=${project.id}`);
                        console.log(`Events for project ${project.id}:`, eventsResponse);
                        if (Array.isArray(eventsResponse)) {
                            events.push(...eventsResponse);
                        }
                    } catch (err) {
                        console.error(`Error fetching events for project ${project.id}:`, err);
                    }
                }
                
                console.log('All maps:', allMaps);
                console.log('All events:', events);
                
                // Populate map filter dropdown
                const mapFilter = document.getElementById('mapFilter');
                mapFilter.innerHTML = '<option value="">All Maps</option>';
                
                allMaps.forEach(map => {
                    const option = document.createElement('option');
                    option.value = map.id;
                    option.textContent = map.name;
                    mapFilter.appendChild(option);
                });
                
                // Render all events
                renderAllEventsTable(events, allMaps);
                
                // Add event listeners for filters
                document.getElementById('projectFilter').addEventListener('change', () => filterEvents(events, allMaps));
                document.getElementById('mapFilter').addEventListener('change', () => filterEvents(events, allMaps));
                document.getElementById('statusFilter').addEventListener('change', () => filterEvents(events, allMaps));
            } catch (error) {
                console.error('Error fetching all events:', error);
            }
        }

        // Render all events table
        function renderAllEventsTable(allEvents, allMaps) {
            const eventsTableBody = document.getElementById('allEventsTableBody');
            eventsTableBody.innerHTML = '';
            
            if (allEvents.length === 0) {
                document.getElementById('allEventsTable').innerHTML = '<div class="alert alert-info">No events found.</div>';
                return;
            }
            
            allEvents.forEach(event => {
                const row = document.createElement('tr');
                
                // Find related map and project
                const map = allMaps.find(m => m.id === event.map_id) || { name: 'Unknown', project_id: null };
                const project = projects.find(p => p.id === map.project_id) || { name: 'Unknown' };
                
                const statusClass = event.status === 'open' ? 'danger' : 
                                   event.status === 'in_progress' ? 'warning' : 'success';
                
                row.innerHTML = `
                    <td>${event.title}</td>
                    <td>${project.name}</td>
                    <td>${map.name}</td>
                    <td>${event.description}</td>
                    <td><span class="badge bg-${statusClass}">${event.status.replace('_', ' ')}</span></td>
                    <td>${new Date(event.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-outline-primary btn-sm view-map" data-id="${event.map_id}">View Map</button>
                    </td>
                `;
                
                eventsTableBody.appendChild(row);
                
                // Add event listener
                row.querySelector('.view-map').addEventListener('click', () => {
                    viewMap(event.map_id);
                });
            });
        }

        // Filter events based on selected filters
        function filterEvents(allEvents, allMaps) {
            const projectId = document.getElementById('projectFilter').value;
            const mapId = document.getElementById('mapFilter').value;
            const status = document.getElementById('statusFilter').value;
            
            let filteredEvents = [...allEvents];
            
            // Filter by status
            if (status) {
                filteredEvents = filteredEvents.filter(event => event.status === status);
            }
            
            // Filter by map
            if (mapId) {
                filteredEvents = filteredEvents.filter(event => event.map_id === parseInt(mapId));
            }
            
            // Filter by project
            if (projectId) {
                const projectMaps = allMaps.filter(map => map.project_id === parseInt(projectId));
                const projectMapIds = projectMaps.map(map => map.id);
                filteredEvents = filteredEvents.filter(event => projectMapIds.includes(event.map_id));
            }
            
            renderAllEventsTable(filteredEvents, allMaps);
        }

        // Create Project Button
        document.getElementById('createProjectBtn').addEventListener('click', () => {
            // Reset form
            document.getElementById('projectName').value = '';
            document.getElementById('projectDesc').value = '';
            
            // Show modal
            createProjectModal.show();
        });

        // Save Project Button
        document.getElementById('saveProjectBtn').addEventListener('click', async () => {
            const name = document.getElementById('projectName').value;
            const description = document.getElementById('projectDesc').value;
            
            if (!name) {
                alert('Project name is required');
                return;
            }
            
            try {
                console.log('Creating project:', { name, description });
                const response = await apiRequest('/projects/', 'POST', {
                    name,
                    description
                });
                console.log('Project created:', response);
                
                // Refresh projects list
                fetchProjects();
                
                // Hide modal
                createProjectModal.hide();
            } catch (error) {
                console.error('Error creating project:', error);
                alert('Failed to create project: ' + error.message);
            }
        });

        // Upload Map Button
        document.getElementById('uploadMapBtn').addEventListener('click', () => {
            // Reset form
            document.getElementById('mapName').value = '';
            document.getElementById('mapFile').value = '';
            document.getElementById('mapUploadError').style.display = 'none';
            
            // Show modal
            uploadMapModal.show();
        });

        // Save Map Button
        document.getElementById('saveMapBtn').addEventListener('click', async () => {
            const name = document.getElementById('mapName').value;
            const fileInput = document.getElementById('mapFile');
            const mapUploadError = document.getElementById('mapUploadError');
            
            if (!name) {
                mapUploadError.textContent = 'Map name is required';
                mapUploadError.style.display = 'block';
                return;
            }
            
            if (!fileInput.files || fileInput.files.length === 0) {
                mapUploadError.textContent = 'Please select a file to upload';
                mapUploadError.style.display = 'block';
                return;
            }
            
            try {
                mapUploadError.style.display = 'none';
                
                const formData = new FormData();
                formData.append('project_id', currentProject.id);
                formData.append('name', name);
                formData.append('map_type', 'implantation'); // Default type
                formData.append('file', fileInput.files[0]);
                
                console.log("Uploading map with project_id:", currentProject.id);
                console.log("File:", fileInput.files[0]);
                
                const response = await apiRequest('/maps/', 'POST', formData);
                console.log('Map uploaded:', response);
                
                // Refresh maps list
                fetchProjectMaps(currentProject.id);
                
                // Hide modal
                uploadMapModal.hide();
            } catch (error) {
                console.error('Error uploading map:', error);
                mapUploadError.textContent = 'Failed to upload map: ' + (error.message || 'Unknown error');
                mapUploadError.style.display = 'block';
            }
        });

        // Initialize the main map view with overlay capabilities
        function initializeMainMapView() {
            const mainMapViewer = document.getElementById('mainMapViewer');
            const mapLayersList = document.getElementById('mapLayersList');
            
            // Clear previous content
            mainMapViewer.innerHTML = '';
            mapLayersList.innerHTML = '';
            
            // Reset active maps tracking
            activeMaps = {};
            
            if (maps.length === 0) {
                mainMapViewer.innerHTML = '<div class="alert alert-info">No maps available for this project. Please upload maps first.</div>';
                return;
            }
            
            // Find implantation map and other maps
            const implantationMap = maps.find(map => (map.map_type || '').toLowerCase() === 'implantation');
            
            // Group maps: implantation (base) first, then others
            const orderedMaps = [];
            
            // Add implantation map first if it exists
            if (implantationMap) {
                orderedMaps.push(implantationMap);
                // Start with implantation map active by default
                activeMaps[implantationMap.id] = true;
            }
            
            // Add other maps
            maps.forEach(map => {
                if (map.id !== implantationMap?.id) {
                    orderedMaps.push(map);
                }
            });
            
            // If no implantation map was found, activate the first map by default
            if (!implantationMap && maps.length > 0) {
                activeMaps[maps[0].id] = true;
            }
            
            // Create checkboxes for each map
            orderedMaps.forEach((map, index) => {
                const isImplantation = map.id === implantationMap?.id;
                
                // Create checkbox for this map
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'form-check map-layer-checkbox-container';
                
                checkboxDiv.innerHTML = `
                    <input class="form-check-input map-layer-checkbox" type="checkbox" value="${map.id}" 
                        id="mapLayer${map.id}" ${isImplantation ? 'checked' : ''}>
                    <label class="form-check-label ${isImplantation ? 'base-map-label' : 'overlay-map-label'}" for="mapLayer${map.id}">
                        ${map.name} ${map.version ? `(v${map.version})` : ''}
                        ${isImplantation ? ' (Base Map)' : ''}
                    </label>
                `;
                mapLayersList.appendChild(checkboxDiv);
            });
            
            // Render the active maps
            renderActiveMaps();
            
            // Add event listeners to checkboxes
            document.querySelectorAll('.map-layer-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const mapId = parseInt(e.target.value);
                    if (e.target.checked) {
                        activeMaps[mapId] = true;
                    } else {
                        delete activeMaps[mapId];
                    }
                    renderActiveMaps();
                });
            });
            
            // Add event listener for adding events
            document.getElementById('addEventBtn').addEventListener('click', () => {
                if (Object.keys(activeMaps).length === 0) {
                    alert('Please select at least one map layer to add an event.');
                    return;
                }
                
                // Show instructions to click on map
                alert('Click on the map where you want to add the event.');
                
                // Change cursor to indicate click mode
                mainMapViewer.style.cursor = 'crosshair';
                
                // Add one-time click listener
                const clickHandler = (e) => {
                    // Remove the click listener
                    mainMapViewer.removeEventListener('click', clickHandler);
                    mainMapViewer.style.cursor = 'default';
                    
                    // Calculate click position
                    handleMainMapClick(e);
                };
                
                mainMapViewer.addEventListener('click', clickHandler);
            });
            
            // Fetch and display events for this project
            fetchProjectEvents();
        }
        
        // Render the active maps in the overlay
        function renderActiveMaps() {
            const mainMapViewer = document.getElementById('mainMapViewer');
            mainMapViewer.innerHTML = '';
            
            // Get active map IDs and corresponding maps
            const activeMapIds = Object.keys(activeMaps).map(id => parseInt(id));
            const activeMapsData = maps.filter(map => activeMapIds.includes(map.id));
            
            if (activeMapsData.length === 0) {
                mainMapViewer.innerHTML = '<div class="alert alert-info">Please select at least one map layer to display.</div>';
                return;
            }
            
            console.log('Rendering active maps:', activeMapsData);
            
            // Create container for maps with explicit height and width
            const mapContainer = document.createElement('div');
            mapContainer.className = 'map-iframe-container';
            mapContainer.style.width = '100%';
            mapContainer.style.height = '600px';
            mapContainer.style.position = 'relative';
            mapContainer.style.backgroundColor = '#f8f9fa';
            mapContainer.style.border = '1px solid #ddd';
            mainMapViewer.appendChild(mapContainer);
            
            // Find implantation map (base map) - it should be displayed first (at the bottom)
            let implantationMap = activeMapsData.find(map => (map.map_type || '').toLowerCase() === 'implantation');
            
            // If no implantation map is found, use the first map as the base
            if (!implantationMap && activeMapsData.length > 0) {
                implantationMap = activeMapsData[0];
            }
            
            // Sort maps to ensure implantation map is first, then others in order of selection
            const sortedMaps = [...activeMapsData].sort((a, b) => {
                if (a.id === implantationMap?.id) return -1;
                if (b.id === implantationMap?.id) return 1;
                return 0;
            });
            
            // Add map event containers
            const eventMarkersContainer = document.getElementById('eventMarkersContainer') || document.createElement('div');
            eventMarkersContainer.id = 'eventMarkersContainer';
            eventMarkersContainer.style.position = 'absolute';
            eventMarkersContainer.style.top = '0';
            eventMarkersContainer.style.left = '0';
            eventMarkersContainer.style.width = '100%';
            eventMarkersContainer.style.height = '100%';
            eventMarkersContainer.style.zIndex = '1000';
            eventMarkersContainer.style.pointerEvents = 'none';
            mainMapViewer.appendChild(eventMarkersContainer);
            
            // Add click handler to the container for event creation
            mapContainer.onclick = handleMainMapClick;
            
            // Add each active map as a layer
            sortedMaps.forEach((map, index) => {
                // Get base URL (without /api/v1)
                const apiUrlBase = API_URL.split('/api/v1')[0];
                
                // Fix URL construction - use the correct filename and path
                let mapUrl;
                if (map.filename) {
                    mapUrl = `${apiUrlBase}/uploads/${map.filename}`;
                } else if (map.file_path) {
                    // Just in case file_path already includes 'uploads/'
                    if (map.file_path.includes('uploads/')) {
                        mapUrl = `${apiUrlBase}/${map.file_path}`;
                    } else {
                        mapUrl = `${apiUrlBase}/uploads/${map.file_path}`;
                    }
                } else {
                    console.error('Map has no filename or file_path:', map);
                    return;
                }
                
                console.log(`Rendering map ${map.id} (${map.name}) at URL: ${mapUrl}`);
                
                const mapDiv = document.createElement('div');
                mapDiv.className = 'map-overlay';
                mapDiv.style.position = 'absolute';
                mapDiv.style.top = '0';
                mapDiv.style.left = '0';
                mapDiv.style.width = '100%';
                mapDiv.style.height = '100%';
                mapDiv.style.zIndex = 10 + index; // Stack maps with increasing z-index
                
                const isBaseMap = map.id === implantationMap?.id;
                
                if (isBaseMap) {
                    // Base map is fully visible
                    mapDiv.style.opacity = '1';
                } else {
                    // Overlay maps are semi-transparent
                    mapDiv.style.opacity = '0.7';
                }
                
                // All maps shouldn't receive pointer events to allow clicks to pass through to container
                mapDiv.style.pointerEvents = 'none';
                
                // Use iframe with specific parameters to show only the PDF without controls
                // This provides the cleanest view of just the PDF content
                mapDiv.innerHTML = `
                    <iframe 
                        src="${mapUrl}#toolbar=0&navpanes=0&scrollbar=0&statusbar=0&messages=0&view=FitH"
                        style="width:100%; height:100%; border:none;"
                        frameborder="0"
                        class="clean-pdf-view">
                    </iframe>
                `;
                
                mapContainer.appendChild(mapDiv);
                
                // Fetch to check if URL is accessible and log the result
                fetch(mapUrl)
                    .then(response => {
                        console.log(`Fetch response for ${mapUrl}:`, response.status, response.statusText);
                        if (response.ok) {
                            console.log('PDF should be displayed successfully');
                        } else {
                            console.error('PDF fetch error:', response.status, response.statusText);
                        }
                        return response;
                    })
                    .catch(error => {
                        console.error(`Error fetching ${mapUrl}:`, error);
                    });
            });
            
            // After rendering maps, render events
            renderProjectEvents();
        }
        
        // Handle click on the main map
        function handleMainMapClick(e) {
            if (Object.keys(activeMaps).length === 0) {
                alert('Please select at least one map layer.');
                return;
            }
            
            const rect = e.currentTarget.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Calculate percentage position
            const xPercent = (x / rect.width) * 100;
            const yPercent = (y / rect.height) * 100;
            
            selectedPosition = { x: xPercent, y: yPercent };
            
            // Show coordinates in the event form
            document.getElementById('eventCoordinates').textContent = `Incident coordinates: X: ${xPercent.toFixed(2)}%, Y: ${yPercent.toFixed(2)}%`;
            
            // Show active map layers
            const activeMapNames = maps
                .filter(map => activeMaps[map.id])
                .map(map => map.name)
                .join(', ');
            
            document.getElementById('activeMapLayers').textContent = `Active map layers: ${activeMapNames}`;
            
            // Show event creation modal
            createEventModal.show();
        }
        
        // Fetch events for the current project
        async function fetchProjectEvents() {
            try {
                // Reset events array
                events = [];
                
                // Fetch events for each map in the project
                for (const map of maps) {
                    try {
                        const mapEvents = await apiRequest(`/events/?map_id=${map.id}`);
                        if (Array.isArray(mapEvents)) {
                            events = [...events, ...mapEvents];
                        }
                    } catch (error) {
                        console.error(`Error fetching events for map ${map.id}:`, error);
                    }
                }
                
                console.log('Project events:', events);
                
                // Render events on the map and in the table
                renderProjectEvents();
                renderRecentEventsTable();
            } catch (error) {
                console.error('Error fetching project events:', error);
            }
        }
        
        // Render event markers on the main map view
        function renderProjectEvents() {
            const eventMarkersContainer = document.getElementById('eventMarkersContainer');
            if (!eventMarkersContainer) return;
            
            // Clear existing markers
            eventMarkersContainer.innerHTML = '';
            
            // Render markers for each event
            events.forEach(event => {
                // Skip events that don't have position data
                if (typeof event.x_coordinate === 'undefined' || typeof event.y_coordinate === 'undefined') {
                    return;
                }
                
                const marker = document.createElement('div');
                marker.className = 'event-marker';
                marker.dataset.eventId = event.id;
                marker.title = event.title;
                marker.style.left = `${event.x_coordinate}%`;
                marker.style.top = `${event.y_coordinate}%`;
                
                // Assign color based on user who created the event
                if (event.user_id) {
                    marker.classList.add(getUserColorClass(event.user_id));
                }
                
                // Add click event to show details popup
                marker.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent triggering map click
                    showEventDetailsPopup(event, e.clientX, e.clientY);
                });
                
                eventMarkersContainer.appendChild(marker);
            });
        }
        
        // Show event details in a popup
        function showEventDetailsPopup(event, clientX, clientY) {
            // Update event details
            document.getElementById('eventDetailsTitle').textContent = event.title;
            document.getElementById('eventDetailsDesc').textContent = event.description || 'No description provided';
            document.getElementById('eventDetailsStatus').textContent = event.status.replace('_', ' ');
            document.getElementById('eventDetailsCreator').textContent = event.user_name || 'Unknown';
            document.getElementById('eventDetailsDate').textContent = new Date(event.created_at).toLocaleString();
            
            // Show event image if available
            const imageContainer = document.getElementById('eventDetailsImageContainer');
            const image = document.getElementById('eventDetailsImage');
            if (event.image_path) {
                const apiUrlBase = API_URL.split('/api/v1')[0];
                image.src = `${apiUrlBase}/uploads/${event.image_path}`;
                imageContainer.style.display = 'block';
            } else {
                imageContainer.style.display = 'none';
            }
            
            // Show active map layers at time of event creation
            document.getElementById('eventDetailsMapLayers').textContent = event.active_maps || 'Not recorded';
            
            // Show the modal
            eventDetailsModal.show();
        }
        
        // Render recent events table
        function renderRecentEventsTable() {
            const eventsTableBody = document.getElementById('recentEventsTableBody');
            eventsTableBody.innerHTML = '';
            
            if (events.length === 0) {
                document.getElementById('recentEventsTable').innerHTML = '<div class="alert alert-info">No events found for this project. Click the "Add Event" button to create a new event.</div>';
                return;
            }
            
            // Sort events by date (newest first)
            const sortedEvents = [...events].sort((a, b) => 
                new Date(b.created_at).getTime() - new Date(a.created_at).getTime()
            );
            
            // Show only the 10 most recent events
            const recentEvents = sortedEvents.slice(0, 10);
            
            recentEvents.forEach(event => {
                const row = document.createElement('tr');
                
                const statusClass = event.status === 'open' ? 'danger' : 
                                   event.status === 'in_progress' ? 'warning' : 'success';
                
                row.innerHTML = `
                    <td>${event.title}</td>
                    <td>${event.description?.substring(0, 50) || ''}${event.description?.length > 50 ? '...' : ''}</td>
                    <td><span class="badge bg-${statusClass}">${event.status.replace('_', ' ')}</span></td>
                    <td>${event.user_name || 'Unknown'}</td>
                    <td>${new Date(event.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-outline-primary btn-sm view-event" data-id="${event.id}">View</button>
                    </td>
                `;
                
                eventsTableBody.appendChild(row);
                
                // Add event listener to view button
                row.querySelector('.view-event').addEventListener('click', () => {
                    showEventDetailsPopup(event);
                });
            });
        }
        
        // Take picture button
        document.getElementById('takePictureBtn').addEventListener('click', () => {
            // Trigger the file input but use the camera
            const eventImage = document.getElementById('eventImage');
            eventImage.setAttribute('capture', 'environment');
            eventImage.click();
        });
        
        // Preview uploaded image
        document.getElementById('eventImage').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('previewImage').src = e.target.result;
                    document.getElementById('capturedImagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Save Event Button
        document.getElementById('saveEventBtn').addEventListener('click', async () => {
            const title = document.getElementById('eventTitle').value;
            const description = document.getElementById('eventDesc').value;
            const status = document.getElementById('eventStatus').value;
            const fileInput = document.getElementById('eventImage');
            const eventError = document.getElementById('eventError');
            
            if (!title) {
                eventError.textContent = 'Event title is required';
                eventError.style.display = 'block';
                return;
            }
            
            if (Object.keys(activeMaps).length === 0) {
                eventError.textContent = 'At least one map must be active';
                eventError.style.display = 'block';
                return;
            }
            
            try {
                eventError.style.display = 'none';
                
                // Get the primary (first) active map
                const primaryMapId = parseInt(Object.keys(activeMaps)[0]);
                
                // Get names of active maps for metadata
                const activeMapNames = maps
                    .filter(map => activeMaps[map.id])
                    .map(map => map.name)
                    .join(', ');
                
                const formData = new FormData();
                formData.append('project_id', currentProject.id);
                formData.append('map_id', primaryMapId);
                formData.append('title', title);
                formData.append('description', description);
                formData.append('x_coordinate', selectedPosition.x);
                formData.append('y_coordinate', selectedPosition.y);
                formData.append('status', status);
                formData.append('active_maps', activeMapNames);
                
                if (fileInput.files && fileInput.files.length > 0) {
                    formData.append('image', fileInput.files[0]);
                }
                
                console.log('Creating event:', Object.fromEntries(formData.entries()));
                const response = await apiRequest('/events/', 'POST', formData);
                console.log('Event created:', response);
                
                // Refresh events
                await fetchProjectEvents();
                
                // Hide modal and reset form
                createEventModal.hide();
                
                document.getElementById('eventTitle').value = '';
                document.getElementById('eventDesc').value = '';
                document.getElementById('eventStatus').value = 'open';
                document.getElementById('eventImage').value = '';
                document.getElementById('capturedImagePreview').style.display = 'none';
                document.getElementById('eventCoordinates').textContent = '';
                document.getElementById('activeMapLayers').textContent = '';
            } catch (error) {
                console.error('Error creating event:', error);
                eventError.textContent = 'Failed to create event: ' + (error.message || 'Unknown error');
                eventError.style.display = 'block';
            }
        });

        // Delete Project Button
        document.getElementById('deleteProjectBtn').addEventListener('click', async () => {
            if (!currentProject) return;
            
            // Show confirmation dialog
            if (!confirm(`Are you sure you want to delete project "${currentProject.name}"? This action cannot be undone.`)) {
                return;
            }
            
            try {
                console.log('Deleting project:', currentProject.id);
                
                // Disable the button while processing
                const deleteBtn = document.getElementById('deleteProjectBtn');
                deleteBtn.disabled = true;
                deleteBtn.textContent = 'Deleting...';
                
                // Send deletion request
                await apiRequest(`/projects/${currentProject.id}`, 'DELETE');
                console.log('Project deleted successfully');
                
                // Show success message
                alert('Project deleted successfully');
                
                // Clear current project
                currentProject = null;
                
                // Refresh projects list and go back to projects view
                await fetchProjects();
                showSection('projects');
            } catch (error) {
                console.error('Error deleting project:', error);
                alert('Failed to delete project: ' + error.message);
                
                // Re-enable the button
                const deleteBtn = document.getElementById('deleteProjectBtn');
                deleteBtn.disabled = false;
                deleteBtn.textContent = 'Delete Project';
            }
        });

        // Initialize
        checkAuth();
    </script>
</body>
</html> 